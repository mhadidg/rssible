<!doctype html>
<html lang="en">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="assets/water.css">
<title>RSSible: URL + CSS = RSS feed</title>
<style>
  body {
    font: 14.666px/1.45 system-u i, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, sans-serif;
    max-width: 720px;
    margin: 3rem auto;
    padding: 0 1rem;
  }

  form {
    display: grid;
    gap: .6rem
  }

  .row {
    display: grid;
    grid-template-columns:1fr 1fr;
    gap: .6rem
  }

  :root {
    --tip-icon: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" aria-hidden="true" viewBox="0 0 24 24" fill="%23555"><circle cx="12" cy="12" r="10" fill="none" stroke="%23555" stroke-width="1.5"/><path d="M12 17h.01M9.5 10.5a2.5 2.5 0 1 1 4.3 1.7c-.7.7-1.3 1-1.3 2.3" stroke="%23555" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>');
  }

  input[title] {
    background-image: var(--tip-icon);
    background-repeat: no-repeat;
    background-position: right .65rem center;
    background-size: 1rem;
    padding-right: 2rem;
  }

  :root {
    --sep: rgba(0, 0, 0, .15);
  }

  .separator {
    border-top: 1px dashed rgba(0, 0, 0, .15);
    margin: .5rem 0;
  }

  #preview code {
    padding: 1.5em;
    max-height: 280px;
    font-size: 0.85em;
    overflow: auto;
  }

  .textarea-wrapper {
    margin-right: 6px;
  }

  textarea {
    line-height: inherit;
  }

  #demos {
    list-style: square;
    padding-left: 16px;
  }
</style>
<h1>RSSible</h1>
<p>
  Paste a URL and CSS selectors; get an RSS feed;
  free and <a href="https://github.com/mhadidg/rssible">opensource</a>.
</p>
<p>
  Runs entirely on the <em>free tier</em> of
  <a href="https://workers.cloudflare.com">Cloudflare workers</a>.
  Click on the demo links ‚§∏ to see it in action.
</p>

<ul id="demos">
  <li>
    <a href="#" class="demo"
       data-config='{"url":"https://news.ycombinator.com","item":".titleline","title":"> a","link":"a","mode":"advanced","filters":"link=/github/i"}'
    >Hacker News</a>: filtered to GitHub links only
  </li>
  <li>
    <a href="#" class="demo"
       data-config='{"url":"https://www.reddit.com/r/programming/top/?t=week","item":"article","title":"faceplate-screen-reader-content","link":"[slot=\"thumbnail\"] a","mode":"lite","limit":"10"}'
    >Reddit r/programming</a>: top 10 over the past 7-days window
  </li>
  <li>
    <a href="#" class="demo"
       data-config='{"url":"https://github.com/trending?since=daily","item":"article","title":"h2","link":"h2 a","desc":"p","mode":"full","limit":"20"}'
    >Github trending repos</a>: updated daily
  </li>
  <li>
    <a href="#" class="demo"
       data-config='{"url":"https://www.imdb.com/search/title/?title_type=tv_series,tv_miniseries&num_votes=10000,&genres=sci-fi&sort=release_date,desc","item":"li.ipc-metadata-list-summary-item","title":".ipc-title","link":"a.ipc-title-link-wrapper","desc":".ipc-html-content-inner-div","mode":"full"}'
    >IMDb Sci-Fi Series</a>: latest; ‚â•10k votes
  </li>
  <li>
    <a href="#" class="demo"
       data-config='{"url":"https://www.anthropic.com/news","item":"a[href^=\"/news\"][class^=\"Card\"]","title":"h3","link":"@","date":"p","mode":"full"}'
    >Anthropic news</a> (special <code>@</code> for link means the item selector itself)
  </li>
</ul>

<form method="GET" action="/feed">
  <input name="url" placeholder="URL of the page" required/>
  <div class="row">
    <!-- "item" would collide with the built-in form.item -->
    <input name="_item" placeholder="Item container (e.g., .post)" title="CSS selector for items (required)" required/>
    <input name="title" placeholder="Title (e.g., .post-title)" title="CSS selector inside each item for title (optional)"/>
  </div>

  <div class="row">
    <input name="link" placeholder="Link (e.g., .post-title a)" title="CSS selector inside each item for link (optional)"/>
    <select name="mode" id="mode">
      <option value="lite" selected>üê£ Lite mode</option>
      <option value="full">üê• Full mode</option>
      <option value="advanced">ü¶Ö Advanced mode</option>
    </select>
  </div>

  <!-- Enabled only when mode=full -->
  <div class="row" id="row-full-only">
    <input name="desc" placeholder="Description (e.g., .post-excerpt)" title="CSS selector for description"/>
    <input name="date" placeholder="Date (e.g., .post-date)" title="CSS selector for pub date; must be parsable by JS Date()."/>
  </div>

  <!-- Enabled only when mode=advanced -->
  <div class="row" id="row-advanced-only">
    <div class="textarea-wrapper">
      <textarea
        name="headers_text" rows="4" title="Empty headers are allowed; unsupported headers will be ignored."
        placeholder="Custom headers (RFC-style, one per line):&#10;User-Agent: RSSible/1.0&#10;Accept: */*"></textarea>
      <input name="headers" type="hidden"/>
    </div>
    <div class="textarea-wrapper">
      <textarea
        name="filters" rows="4" title="Supported keys: item, title, link, desc. 'item' matches any text inside."
        placeholder="Filters (JS-style, one per line; hover for keys):&#10;item=/keyword/i&#10;title=/python|rust/i"></textarea>
    </div>
  </div>

  <div class="row">
    <input name="limit" placeholder="Limit (e.g, 10)" title="Max number of items to include (default 5, max 25)"/>
    <span><!-- keep for alignment --></span>
  </div>

  <div class="row">
    <button type="button" id="preview-btn" title="Show first two items as RSS <item> nodes">Preview</button>
    <button type="submit" title="Build the RSS feed URL">Copy link</button>
  </div>
</form>

<p></p>

<small>
  <b>Important:</b> Don't repeat the <em>item</em> selector in title/link/desc/date selectors.
  Think of the <em>item</em> as the div container for, say, article, and <em>item details</em>
  as the elements <em>inside</em> each article. If multiple elements match, the first wins.<br>

  <div class="separator"></div>

  <b>Pro tip:</b> Use <code>:first-of-type</code> or <code>:nth-of-type(n)</code> if
  the selector matches multiple sibling elements <em>inside</em> the <em>item</em>.<br>

  <div class="separator"></div>

  <b>Pro tip:</b> To <em>exclude</em> items with certain words, use a negative lookahead regex.
  For example, <code>/^(?!.*(python|rust)).*$/</code> matches everything except strings
  containing "python" or "rust".<br>
</small>

<pre id="preview">
  <code>// üëÄ Your preview will show up here...</code>
</pre>

<script>
  // Disable mode-specific fields when mode changes
  (function () {
    const mode = document.getElementById('mode');

    const fullRow = document.getElementById('row-full-only');
    const desc = fullRow.querySelector('[name="desc"]');
    const date = fullRow.querySelector('[name="date"]');

    const advancedRow = document.getElementById('row-advanced-only');
    const headers = advancedRow.querySelector('[name="headers_text"]');
    const filters = advancedRow.querySelector('[name="filters"]');

    function sync() {
      const isFull = mode.value === 'full';
      const isAdvanced = mode.value === 'advanced';

      desc.disabled = !(isFull || isAdvanced);
      date.disabled = !(isFull || isAdvanced);
      headers.disabled = !isAdvanced;
      filters.disabled = !isAdvanced;

      // If disabled clear values
      if (desc.disabled) desc.value = '';
      if (date.disabled) date.value = '';
      if (headers.disabled) headers.value = '';
      if (filters.disabled) filters.value = '';
    }

    mode.addEventListener('change', sync);
    sync();
  })();
</script>

<!--suppress CssInvalidHtmlTagReference -->
<script>
  // Preview RSS feed with first two items
  const form = document.querySelector('form');
  const previewBtn = document.getElementById('preview-btn');
  const previewBox = document.getElementById('preview');
  const previewCode = previewBox.querySelector('code');

  async function previewTwo() {
    const previewUrl = buildFeedURL(2);
    const fullUrl = buildFeedURL();

    previewCode.textContent = 'Loading preview‚Ä¶';

    try {
      const res = await fetch(previewUrl);
      if (!res.ok) throw new Error(await res.text());
      const xml = await res.text();

      const doc = new DOMParser().parseFromString(xml, 'application/xml');
      const items = Array.from(doc.querySelectorAll('item')).slice(0, 2);

      const lines = items.map(it => {
        const title = it.querySelector('title')?.textContent?.trim() || '(empty)';
        const link = it.querySelector('link')?.textContent?.trim() || '(empty)';
        const desc = it.querySelector('description')?.textContent?.trim();
        const date = it.querySelector('pubDate')?.textContent?.trim();

        let block = `Title: ${title}\nLink: ${link}`;
        if (desc) block += `\nDesc: ${desc}`;
        if (date) block += `\nDate: ${date}`;
        return block;
      });

      const body = items.length
        ? lines.join('\n\n') + '\n\n...'
        : '// No items found.';

      // URL first, then items
      previewCode.textContent = `Feed URL: ${fullUrl}\n\n${body}`;
    } catch (e) {
      previewCode.textContent = '// ' + (e.message || String(e) || 'Unknown error.');
    }
  }

  previewBtn.addEventListener('click', previewTwo);
</script>

<script>
  // Intercept form submit to copy the URL instead
  const submitBtn = form.querySelector('button[type="submit"]');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const u = buildFeedURL();
    try {
      await navigator.clipboard.writeText(u.toString());
      const prev = submitBtn.textContent;
      submitBtn.textContent = 'Copied!';
      setTimeout(() => (submitBtn.textContent = prev), 1200);
    } catch {
      alert('Copy failed. You can copy it from the preview box.');
    }
  });

  function buildFeedURL(limit) {
    const fd = new FormData(form);
    const qs = new URLSearchParams();

    // Get rid of empty params
    for (const [key, val] of fd.entries()) {
      if (key === 'headers_text') continue;
      const v = val.trim?.() ?? val;
      if (v) qs.set(key, v);
    }

    // Override in preview mode
    if (limit != null) qs.set('limit', String(limit));

    const u = new URL('/feed', location.href);
    u.search = qs.toString();
    return u;
  }
</script>

<script>
  // Retain form values on page reload
  (function () {
    const KEY = 'rssible-form';
    const form = document.querySelector('form');

    // Restore on load
    try {
      const saved = localStorage.getItem(KEY);
      if (saved) {
        const params = new URLSearchParams(saved);
        for (const [k, v] of params) {
          const el = form.elements[k];
          if (!el) continue;
          el.value = v;
        }

        // Enable/disable mode-specific fields
        const mode = form.elements['mode'];
        mode && mode.dispatchEvent(new Event('change'));
      }
    } catch {}

    // Save on every change/input
    function save() {
      const params = new URLSearchParams();
      for (const el of form.elements) {
        if (!el.name) continue;
        const val = (el.value || '').trim();
        if (val) params.set(el.name, val);
      }

      try { localStorage.setItem(KEY, params.toString()); } catch {}
    }

    form.addEventListener('input', save, { passive: true });
  })();
</script>

<script>
  // Sync headers textarea with hidden base64 field
  const advancedRow = document.getElementById('row-advanced-only');
  const headersText = advancedRow.querySelector('textarea[name="headers_text"]');
  const headersB64 = advancedRow.querySelector('input[name="headers"]');

  // Encode into base64 for transport
  function encodeHeaders(raw) {
    return raw ? btoa(raw) : "";
  }

  // Keep hidden field in sync with textarea
  headersText.addEventListener('input', () => {
    headersB64.value = encodeHeaders(headersText.value.trim());
  });

  // Patch buildFeedURL so headers are always up-to-date
  const originalBuildFeedURL = buildFeedURL;
  buildFeedURL = function (limit) {
    headersB64.value = encodeHeaders(headersText.value.trim());
    return originalBuildFeedURL(limit);
  };
</script>

<script>
  // Invoke preview on demo link click
  (function () {
    const form = document.querySelector('form');
    const modeEl = form.elements['mode'];
    const filtersEl = document.querySelector('#row-advanced-only [name="filters"]');
    const previewBtn = document.getElementById('preview-btn');

    function fill(config) {
      const mapping = {
        url: 'url', item: '_item', title: 'title', link: 'link',
        desc: 'desc', date: 'date', limit: 'limit'
      };

      // Clear all fields first
      for (const el of form.elements) {
        if (el.name) el.value = '';
      }

      for (const [k, formName] of Object.entries(mapping)) {
        if (config[k] != null) form.elements[formName].value = config[k];
      }

      // Enable/disable mode-specific fields
      if (config.mode) {
        modeEl.value = config.mode;
        modeEl.dispatchEvent(new Event('change'));
      }

      // Now we can update mode-specific fields
      if (config.filters != null) {
        filtersEl.value = config.filters;
      }
    }

    document.querySelectorAll('#demos .demo').forEach(link => {
      link.addEventListener('click', event => {
        event.preventDefault();
        fill(JSON.parse(link.dataset.config));
        previewBtn.click();
      });
    });
  })();
</script>
</html>
